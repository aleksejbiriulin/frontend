<script>
    // ==== Scroll Fixed Header ====
    window.addEventListener('scroll', () => {
        const header = document.querySelector('header');
        if (window.scrollY > 100) {
            header.style.position = 'fixed';
            header.style.top = '0';
            header.style.width = '100%';
            header.style.zIndex = '999';
        } else {
            header.style.position = 'relative';
        }
    });

    // ==== Gallery Popup ====
    const galleryGrid = document.getElementById('gallery-grid');
    const imagePopup = document.getElementById('image-popup');
    const popupImage = document.getElementById('popup-image');
    const popupClose = document.getElementById('popup-close');
    const popupPrev = document.getElementById('popup-prev');
    const popupNext = document.getElementById('popup-next');

    let currentGalleryIndex = 0;
    let galleryImages = [];

    function updateGallery() {
        galleryImages = Array.from(document.querySelectorAll('.post img'));
        galleryGrid.innerHTML = '';
        galleryImages.forEach(img => {
            const clone = img.cloneNode();
            clone.classList.add('gallery-item');
            clone.addEventListener('click', () => {
                currentGalleryIndex = galleryImages.indexOf(img);
                updatePopupImage();
                imagePopup.style.display = 'flex';
            });
            galleryGrid.appendChild(clone);
        });
    }

    function updatePopupImage() {
        if (galleryImages[currentGalleryIndex]) {
            popupImage.src = galleryImages[currentGalleryIndex].src;
        }
        popupPrev.style.visibility = currentGalleryIndex === 0 ? 'hidden' : 'visible';
        popupNext.style.visibility = currentGalleryIndex === galleryImages.length - 1 ? 'hidden' : 'visible';
    }

    popupClose.addEventListener('click', () => {
        imagePopup.style.display = 'none';
    });

    popupPrev.addEventListener('click', () => {
        if (currentGalleryIndex > 0) {
            currentGalleryIndex--;
            updatePopupImage();
        }
    });

    popupNext.addEventListener('click', () => {
        if (currentGalleryIndex < galleryImages.length - 1) {
            currentGalleryIndex++;
            updatePopupImage();
        }
    });

    // ==== Countdown ====
    function updateCountdown() {
        const targetDate = new Date("2026-06-30T00:00:00");
        const now = new Date();
        const diff = targetDate - now;

        if (diff <= 0) {
            document.getElementById('countdown').textContent = "üéâ –í—ã–ø—É—Å–∫!";
            return;
        }

        const days = Math.floor(diff / (1000 * 60 * 60 * 24));
        const hours = Math.floor((diff / (1000 * 60 * 60)) % 24);
        const minutes = Math.floor((diff / (1000 * 60)) % 60);
        const seconds = Math.floor((diff / 1000) % 60);

        document.getElementById('countdown').textContent =
            `${days} –¥–Ω. ${hours} —á. ${minutes} –º–∏–Ω. ${seconds} —Å–µ–∫.`;
    }

    setInterval(updateCountdown, 1000);
    updateCountdown();

    // ==== SVG Animation ====
    const svg = document.getElementById('animated-svg');
    document.addEventListener('mousemove', (e) => {
        const x = e.clientX / window.innerWidth;
        const y = e.clientY / window.innerHeight;
        const cx = 50 + x * 20 - 10;
        const cy = 50 + y * 20 - 10;
        svg.querySelector('circle').setAttribute('cx', cx);
        svg.querySelector('circle').setAttribute('cy', cy);
    });

    // ==== Theme Toggle ====
    const themeToggle = document.getElementById('theme-toggle');
    themeToggle.addEventListener('click', () => {
        document.body.classList.toggle('dark-theme');
        localStorage.setItem('theme', document.body.classList.contains('dark-theme') ? 'dark' : 'light');
    });

    if (localStorage.getItem('theme') === 'dark') {
        document.body.classList.add('dark-theme');
    }

    // ==== Post System ====
    document.addEventListener('DOMContentLoaded', function () {
        const postForm = document.getElementById('postForm');
        const titleInput = document.getElementById('post-title');
        const contentInput = document.getElementById('post-content');
        const imageInput = document.getElementById('post-image');
        const postsContainer = document.getElementById('posts-container');
        let posts = JSON.parse(localStorage.getItem('posts')) || [];

        renderPosts();

        postForm.addEventListener('submit', function (e) {
            e.preventDefault();
            if (validateForm()) {
                const reader = new FileReader();
                const file = imageInput.files[0];
                let imageUrl = '';

                if (file) {
                    reader.readAsDataURL(file);
                    reader.onload = function () {
                        imageUrl = reader.result;
                        createAndRenderPost(imageUrl);
                    };
                } else {
                    createAndRenderPost('');
                }
            }
        });

        function validateForm() {
            let isValid = true;

            if (titleInput.value.trim().length < 5 || titleInput.value.trim().length > 100) {
                titleInput.classList.add('is-invalid');
                isValid = false;
            } else {
                titleInput.classList.remove('is-invalid');
            }

            if (contentInput.value.trim().length < 20 || contentInput.value.trim().length > 1000) {
                contentInput.classList.add('is-invalid');
                isValid = false;
            } else {
                contentInput.classList.remove('is-invalid');
            }

            return isValid;
        }

        function createAndRenderPost(imageUrl) {
            const newPost = {
                id: Date.now(),
                title: titleInput.value.trim(),
                content: contentInput.value.trim(),
                image: imageUrl,
                date: new Date().toLocaleString('ru-RU')
            };

            posts.unshift(newPost);
            localStorage.setItem('posts', JSON.stringify(posts));
            postForm.reset();
            renderPosts();
            updateGallery();
        }

        function renderPosts() {
            if (posts.length === 0) {
                postsContainer.innerHTML = '<div class="empty-state">–ù–µ—Ç –ø–æ—Å—Ç–æ–≤. –°–æ–∑–¥–∞–π—Ç–µ –ø–µ—Ä–≤—ã–π!</div>';
                return;
            }

            postsContainer.innerHTML = '';
            posts.forEach(post => {
                const postElement = document.createElement('article');
                postElement.className = 'post';

                postElement.innerHTML = `
                    ${post.image ? `<img src="${post.image}" alt="–§–æ—Ç–æ –ø–æ—Å—Ç–∞">` : ''}
                    <div class="post-content">
                        <h3 class="post-title">${post.title}</h3>
                        <p>${post.content}</p>
                        <div class="post-meta">–î–∞—Ç–∞: ${post.date}</div>
                        <button class="btn btn-danger" data-id="${post.id}">–£–¥–∞–ª–∏—Ç—å</button>
                    </div>
                `;

                postsContainer.appendChild(postElement);
            });

            // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –Ω–∞ –∫–Ω–æ–ø–∫–∏ —É–¥–∞–ª–µ–Ω–∏—è
            document.querySelectorAll('.btn-danger').forEach(btn => {
                btn.addEventListener('click', function () {
                    const postId = parseInt(this.getAttribute('data-id'));
                    deletePost(postId);
                });
            });
        }

        function deletePost(postId) {
            posts = posts.filter(post => post.id !== postId);
            localStorage.setItem('posts', JSON.stringify(posts));
            renderPosts();
            updateGallery();
        }
    });
</script>
